#!/usr/bin/env bash
# Manage git worktrees with fzf-tmux: list, switch (with tmux session), create new.
# Run from inside a git repo. Uses fzf-tmux everywhere; preview shows diff from main.

set -e

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || { echo "Not in a git repo." >&2; exit 1; }
cd "$REPO_ROOT"
MAIN_BRANCH=$(git rev-parse --abbrev-ref main 2>/dev/null || echo "main")
CURRENT_REF=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "$MAIN_BRANCH")

# Canonical "primary" worktree path (usually the original checkout), used only for naming.
PRIMARY_WORKTREE=$(git worktree list --porcelain 2>/dev/null | awk '/^worktree /{print $2; exit}' || echo "$REPO_ROOT")

FZF_TMUX_OPTS="-d20 --reverse"
FZF_PREVIEW_WINDOW="right:60%"

FZF_KEY_SWITCH="enter"
FZF_KEY_NEW_BRANCH="ctrl-b"
FZF_KEY_DETACHED="ctrl-h"
FZF_KEY_DELETE="ctrl-x"
FZF_KEY_CODE="ctrl-o"
FZF_KEY_FETCH_BRANCHES="ctrl-f"
FZF_KEY_VIMDIFF="ctrl-v"
FZF_KEY_GOBACK="esc"
FZF_KEY_YOINK="ctrl-y"

select_commit_with_fzf() {
  git log --oneline --decorate --graph --all \
    | fzf $FZF_TMUX_OPTS \
        --prompt "commit (detached): " \
        --header "Pick a commit to create a detached worktree" \
        --preview "git show --stat --color=always \$(echo {} | awk '{print \$2}')" \
        --preview-window="$FZF_PREVIEW_WINDOW"\
        --bind "${FZF_KEY_GOBACK}:become(open-worktree)" \
        --footer "${FZF_KEY_GOBACK}: go back"
}

select_worktree_with_fzf() {
  local worktree_lines=$1
  export REPO_ROOT MAIN_BRANCH
  echo "$worktree_lines" | fzf $FZF_TMUX_OPTS \
    --prompt "Select worktree: " \
    --preview "git -C \"$REPO_ROOT\" -c color.ui=always diff --color=always \"$CURRENT_REF..\$(echo {} | awk '{print \$NF}' | tr -d '[]')\" 2>/dev/null || echo '(same as $CURRENT_REF)'" \
    --preview-window="$FZF_PREVIEW_WINDOW" \
    --bind "${FZF_KEY_CODE}:execute(bash -lc 'path=\$(echo {} | awk \"{print \\$1}\"); code \"\$path\"')+accept" \
    --bind "${FZF_KEY_NEW_BRANCH}:execute(open-worktree --create)+abort" \
    --bind "${FZF_KEY_DETACHED}:execute(open-worktree --create-detached)+abort" \
    --bind "${FZF_KEY_DELETE}:execute(open-worktree --delete {})+reload(git worktree list)" \
    --bind "${FZF_KEY_VIMDIFF}:execute(open-worktree --view-diff-files {})" \
    --bind "${FZF_KEY_YOINK}:execute(open-worktree --yoink {})+abort" \
    --footer "${FZF_KEY_SWITCH}: switch | ${FZF_KEY_NEW_BRANCH}: new branch worktree | ${FZF_KEY_DETACHED}: detached | ${FZF_KEY_DELETE}: delete | ${FZF_KEY_CODE}: code | ${FZF_KEY_VIMDIFF}: vimdiff file list | ${FZF_KEY_YOINK}: copy path"
}

select_branch_with_fzf() {
  {
    echo "[create new branch]"
    git branch --format='%(refname:short)' | sort
  } | fzf $FZF_TMUX_OPTS \
    --bind "${FZF_KEY_GOBACK}:become(open-worktree)" \
    --bind "${FZF_KEY_FETCH_BRANCHES}:execute(git fetch --all --prune >/dev/null 2>&1)+reload(git branch --format='%(refname:short)' | sort)" \
    --footer "${FZF_KEY_GOBACK}: go back | [create new branch]: make new | ${FZF_KEY_FETCH_BRANCHES}: fetch branches" \
    --prompt "branch: "
  }

worktree_to_session_name() {
  local path=$1
  local repo_dir_base worktree session_name
  repo_dir_base=$(basename "$(dirname "$path")")
  worktree=$(basename "$path")
  session_name="$repo_dir_base ($worktree)"
  echo "${session_name//./}"
}

attach_or_create_tmux_session() {
  local path=$1
  local clean_session_name
  # If repo root then we switch to main session
  if [[ "$path" == "$PRIMARY_WORKTREE" ]]; then
    local base
    base=$(basename "$PRIMARY_WORKTREE")
    # remove dots
    clean_session_name="${base//./}"
  else
    clean_session_name=$(worktree_to_session_name "$path")
  fi
  if ! tmux has-session -t "$clean_session_name" 2>/dev/null; then
    tmux new-session -c "$path" -s "$clean_session_name" -d
  fi
  tmux switch-client -t "$clean_session_name"
}

list_and_switch_worktrees() {
  local worktree_lines path selected
  worktree_lines=$(git worktree list)
  selected=$(select_worktree_with_fzf "$worktree_lines")
  [[ -z "$selected" ]] && return 0
  path=$(echo "$selected" | awk '{print $1}')
  attach_or_create_tmux_session "$path"
}

create_new_worktree() {
  local repo_basename path branch_selected
  repo_basename=$(basename "$REPO_ROOT")
  branch_selected=$(select_branch_with_fzf) || return 0
  [[ -z "$branch_selected" ]] && return 0

  if [[ "$branch_selected" == "[create new branch]" ]]; then
    # Use a tiny fzf prompt to read the new branch name (no stdin issues)
    branch_selected=$(
      printf '' | fzf $FZF_TMUX_OPTS \
        --print-query \
        --prompt "New branch name: " \
        --header "Type a new git branch name and press enter" \
        | head -n1
    )
    [[ -z "$branch_selected" ]] && return 0
    if ! git check-ref-format --branch "$branch_selected" >/dev/null 2>&1; then
      echo "Invalid branch name: '$branch_selected'" >&2
      return 1
    fi
  fi

  path="/tmp/${repo_basename}/${branch_selected}"

  # If the branch already exists, use it; otherwise create it from MAIN_BRANCH
  if git rev-parse --verify --quiet "$branch_selected" >/dev/null; then
    git worktree add "$path" "$branch_selected"
  else
    git worktree add -b "$branch_selected" "$path" "$MAIN_BRANCH"
  fi

  attach_or_create_tmux_session "$path"
}

create_detached_worktree() {
  local repo_basename commit_line commit_hash path
  repo_basename=$(basename "$REPO_ROOT")

  commit_line=$(select_commit_with_fzf) || return 0
  [[ -z "$commit_line" ]] && return 0

  commit_hash=$(echo "$commit_line" | awk '{print $2}')
  [[ -z "$commit_hash" ]] && return 1

  path="/tmp/${repo_basename}/detached-${commit_hash}"

  git worktree add --detach "$path" "$commit_hash"
  attach_or_create_tmux_session "$path"
}

delete_worktree() {
  local path
  path="${1:-}"
  # If we got a full `git worktree list` line, trim to just the path
  path=$(echo "$path" | awk '{print $1}')

  # Never delete the primary repo worktree
  if [[ -z "$path" || "$path" == "$REPO_ROOT" ]]; then
    echo "Refusing to delete primary worktree: $path" >&2
    return 1
  fi

  # Kill associated tmux session if it exists
  local session_name
  session_name=$(worktree_to_session_name "$path")
  if tmux has-session -t "$session_name" 2>/dev/null; then
    tmux kill-session -t "$session_name"
  fi

  git worktree remove "$path"
}

view_diff_files_vimdiff() {
  local line="$1"
  local path commit file

  # Extract just the worktree path from the full `git worktree list` line
  path=$(echo "$line" | awk '{print $1}')

  # Resolve the worktree's HEAD commit
  commit=$(git -C "$path" rev-parse HEAD) || return 1

  # List changed files between CURRENT_REF and this worktree's HEAD, pick one with fzf
  file=$(
    git -C "$REPO_ROOT" diff --name-only "$CURRENT_REF..$commit" \
      | fzf $FZF_TMUX_OPTS \
          --prompt "vimdiff file: " \
          --preview "git -C \"$REPO_ROOT\" -c color.ui=always diff --color=always \"$CURRENT_REF..$commit\" -- {}" \
          --preview-window="$FZF_PREVIEW_WINDOW"
  )
  [[ -z "$file" ]] && return 0

  # Open the file in vimdiff: current worktree vs selected worktree
  "${EDITOR:-nvim}" -d "$REPO_ROOT/$file" "$path/$file"
}

yoink_worktree_path() {
  local line="$1"
  local path
  path=$(echo "$line" | awk '{print $1}')
  printf '%s\n' "$path" | pbcopy
  printf 'Copied worktree path: %s\n' "$path"
}


if [[ "${1:-}" == "--create" ]]; then
  create_new_worktree
  exit 0
fi

if [[ "${1:-}" == "--create-detached" ]]; then
  create_detached_worktree
  exit 0
fi

if [[ "${1:-}" == "--delete" ]]; then
  shift
  delete_worktree "$@"
  exit 0
fi

if [[ "${1:-}" == "--view-diff-files" ]]; then
  shift
  view_diff_files_vimdiff "$@"
  exit 0
fi

if [[ "${1:-}" == "--yoink" ]]; then
  shift
  yoink_worktree_path "$@"
  exit 0
fi

list_and_switch_worktrees
